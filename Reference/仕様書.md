---

# 🛠️ 開発指示・技術仕様書：SOMEBODY SUMMON ME!

## 1. プロジェクト概要

本作は、既存の3DアクションRPGのコードベースを拡張し、「倒した敵を味方に変えて増殖させる」集団戦アクションゲームへと改造するプロジェクトである。

## 2. 現状のシステム構成（解析対象）

エージェントは以下の既存スクリプトを読み込み、そのロジックを継承して機能拡張を行うこと。

* **StatusManager.cs**: HP管理、レベル制、ダメージ処理、死亡イベント (`OnDead`) を担当。
* **EnemyAI.cs**: ステートマシン（Chase, Battle, Stun）による行動制御。`defaultTargetTag` で狙う相手を決める。
* **EnemyAction / EnemyActionDash.cs**: AIから呼び出される具体的な攻撃・移動アクション。
* **DamageSource / Hitbox.cs**: Unityのレイヤーベースの当たり判定。
* `PlayerAttack` レイヤーは `EnemyHitbox` にのみヒットする。
* `EnemyAttack` レイヤーは `PlayerHitbox` にのみヒットする。


* **既存タグ**: `Player` (操作キャラ), `Enemy` (敵警察官), `Payload` (護衛対象)。

## 3. 追加機能の技術要件

### A. 味方NPC (Ally) の定義

* **属性**: タグは `Ally`、レイヤーは `PlayerHitbox` とする。
* **攻撃**: 攻撃判定のレイヤーは `PlayerAttack` を使用する。
* **AI**: `EnemyAI.cs` をベースとした **`AllyAI.cs`** を新規作成する。
* `defaultTargetTag` の初期値を `"Enemy"` に設定し、警察官を自動で狙うようにする。



### B. 感染・転生システム (Infection)

* **トリガー**: `Tag: Enemy` を持つオブジェクトの `StatusManager.OnDead` イベント。
* **挙動**: 敵が消滅した座標に、味方NPC（`AllyAI` 搭載の `Ally_MiniMask` プレハブ）を生成する。

### C. 不死・気絶システム (Dizzy State)

* **対象**: `Tag: Ally` を持つ味方NPC。
* **拡張**: `StatusManager.DestoryMainObject` を修正する。
* `Tag: Ally` の場合のみ、オブジェクトを `Destroy` せず、新規フラグ `IsDizzy = true` を立てて `AllyAI` コンポーネントを `enabled = false` にする。
* `Tag: Enemy` の場合は既存の破壊フローを維持する。



### D. 全域蘇生スキル (Global Revive)

* **挙動**: プレイヤーが発動する。シーン内の `Tag: Ally` かつ `IsDizzy == true` の個体を全検索する。
* **回復**: `StatusManager.MaxHeal()` を実行し、`IsDizzy = false` に戻して `AllyAI` を再起動する。

### E. 合体システム (Merge 10)

* **挙動**: プレイヤー周囲の `Tag: Ally` かつ生存個体が10体以上の場合、それらを削除し、強化版プレハブ `HatMask` を1体生成する。

## 4. エージェントへの制約事項

* **破壊的変更の禁止**: `DamageSource.cs` や `Hitbox.cs` の計算ロジック、および既存のレイヤーマトリックス設定を前提とした判定処理は**一切書き換えないこと**。
* **拡張による対応**: 可能な限り新規クラス（`AllyAI`, `InfectionManager`, `ReviveManager`）で実装し、既存クラス（`StatusManager`）への変更は最小限のIF文挿入に留めること。
* **手動作業の明示**: コンポーネントのアタッチやプレハブの参照設定など、コード外の作業が必要な場合は `HumanToDo.md` に手順を記載すること。

---

## 5. Antigravity（AIエージェント）への初動指示

1. 提供されたスクリプト群（`StatusManager.cs`, `EnemyAI.cs`等）を解析せよ。
2. 上記「3. 追加機能の技術要件」が既存ロジックと衝突しないか検証せよ。
3. 検証後、各ファイルに対する具体的な修正・新規作成コード案を提示せよ。

---